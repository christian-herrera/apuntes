<!doctype html>
<html lang="es" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-esp32/OTA_update" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.9.2">
<title data-rh="true">Actualización OTA | Apuntes</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://apuntes.christianherrera.com.ar/docs/esp32/OTA_update"><meta data-rh="true" property="og:locale" content="es"><meta data-rh="true" name="docusaurus_locale" content="es"><meta data-rh="true" name="docsearch:language" content="es"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Actualización OTA | Apuntes"><meta data-rh="true" name="description" content="Guia para realizar actualizaciones Over-The-Air (OTA) en dispositivos ESP32."><meta data-rh="true" property="og:description" content="Guia para realizar actualizaciones Over-The-Air (OTA) en dispositivos ESP32."><link data-rh="true" rel="icon" href="/img/logo.png"><link data-rh="true" rel="canonical" href="https://apuntes.christianherrera.com.ar/docs/esp32/OTA_update"><link data-rh="true" rel="alternate" href="https://apuntes.christianherrera.com.ar/docs/esp32/OTA_update" hreflang="es"><link data-rh="true" rel="alternate" href="https://apuntes.christianherrera.com.ar/docs/esp32/OTA_update" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Actualización OTA","item":"https://apuntes.christianherrera.com.ar/docs/esp32/OTA_update"}]}</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.24/dist/katex.min.css" integrity="sha384-odtC+0UGzzFL/6PNoE8rX/SPcQDXBJ+uRepguP4QkPCm2LBxH3FA3y+fKSiJ+AmM" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.ed559abb.css">
<script src="/assets/js/runtime~main.b31bd83f.js" defer="defer"></script>
<script src="/assets/js/main.61119f3e.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>document.documentElement.setAttribute("data-theme","dark"),document.documentElement.setAttribute("data-theme-choice","dark"),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/img/logo.svg"><div role="region" aria-label="Saltar al contenido principal"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Saltar al contenido principal</a></div><nav aria-label="Principal" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Alternar barra lateral" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Apuntes</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/intro">Bunker de Notas</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a href="https://github.com/christian-herrera" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Volver al principio" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Barra lateral de Documentos" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/intro"><span title="Introducción" class="linkLabel_WmDU">Introducción</span></a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/quarto/instalacion"><span title="Presentaciones Quarto" class="categoryLinkLabel_W154">Presentaciones Quarto</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/react/instalacion"><span title="React JS" class="categoryLinkLabel_W154">React JS</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/php/passwords"><span title="PHP" class="categoryLinkLabel_W154">PHP</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/ubuntu/wireguard"><span title="Ubuntu" class="categoryLinkLabel_W154">Ubuntu</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/lenguaje-c/namespaces"><span title="Lenguaje C/C++" class="categoryLinkLabel_W154">Lenguaje C/C++</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/python/introduccion"><span title="Python" class="categoryLinkLabel_W154">Python</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" href="/docs/esp32/hello_world"><span title="ESP32-C3 Super Mini" class="categoryLinkLabel_W154">ESP32-C3 Super Mini</span></a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/esp32/hello_world"><span title="Hello World" class="linkLabel_WmDU">Hello World</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/esp32/partitions"><span title="Particiones de Memoria" class="linkLabel_WmDU">Particiones de Memoria</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/esp32/wifi_lib"><span title="Libreria WiFi.h" class="linkLabel_WmDU">Libreria WiFi.h</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/esp32/get_post_https"><span title="Libreria WiFiClientSecure.h" class="linkLabel_WmDU">Libreria WiFiClientSecure.h</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/esp32/webserver"><span title="Libreria WebServer.h" class="linkLabel_WmDU">Libreria WebServer.h</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/esp32/OTA_update"><span title="Actualización OTA" class="linkLabel_WmDU">Actualización OTA</span></a></li></ul></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Rastro de navegación"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="Página de Inicio" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">ESP32-C3 Super Mini</span></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">Actualización OTA</span></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">En esta página</button></div><div class="theme-doc-markdown markdown"><header><h1>Actualización OTA</h1></header>
<!-- -->
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="introducción">Introducción<a href="#introducción" class="hash-link" aria-label="Enlace directo al Introducción" title="Enlace directo al Introducción" translate="no">​</a></h2>
<p>La actualizacón Over-The-Air (OTA) permite actualizar el firmware de un dispositivo ESP32 sin necesidad de conexión física. Esto es especialmente útil para dispositivos desplegados en ubicaciones remotas. La forma preferida de implementar OTA en ESP32 es utilizando un servidor web para alojar las actualizaciones de firmware.</p>
<hr style="margin-top:40px">
<!-- -->
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="servidor">Servidor<a href="#servidor" class="hash-link" aria-label="Enlace directo al Servidor" title="Enlace directo al Servidor" translate="no">​</a></h2>
<p>El primer paso es configurar un servidor web para alojar dos archivos esenciales:</p>
<ul>
<li class=""><code>firmware.bin</code>: El archivo binario del firmware que se va a actualizar.</li>
<li class=""><code>version.txt</code>: Un archivo de texto que contiene la versión actual del firmware.</li>
</ul>
<p>El dispositivo ESP32 verificará de la siguiente forma:</p>
<ul>
<li class="">Descargar <code>version.txt</code> desde el servidor.</li>
<li class="">Comparar la versión en <code>version.txt</code> con la versión actual del firmware.</li>
<li class="">Si la versión en el servidor es más reciente, procederá a descargar <code>firmware.bin</code> y actualizar el firmware.</li>
</ul>
<p>Para el ejemplo, utilizaremos un servidor web simple al que se puede acceder desde <code>http://apuntes.christianherrera.com.ar/ota/</code>.</p>
<hr style="margin-top:40px">
<!-- -->
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="sketch-básico">Sketch Básico<a href="#sketch-básico" class="hash-link" aria-label="Enlace directo al Sketch Básico" title="Enlace directo al Sketch Básico" translate="no">​</a></h2>
<p>El microcontrolador tendrá dos funciones principales:</p>
<br>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="verificar-la-versión-del-firmware-en-el-servidor">Verificar la versión del firmware en el servidor.<a href="#verificar-la-versión-del-firmware-en-el-servidor" class="hash-link" aria-label="Enlace directo al Verificar la versión del firmware en el servidor." title="Enlace directo al Verificar la versión del firmware en el servidor." translate="no">​</a></h3>
<p>Se utiliza el ejemplo visto en <a class="" href="/docs/esp32/get_post_https#petici%C3%B3n-get">Solicitud GET con HTTPS</a>. La idea es solicitar el archivo <code>version.txt</code> y devolver la versión como un entero. En caso de error, se devolverá <code>-1</code>.</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#ebdbb2;--prism-background-color:#292828"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#ebdbb2;background-color:#292828"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ebdbb2"><span class="token keyword" style="color:#ea6962">int</span><span class="token plain"> </span><span class="token function" style="color:#d8a657">checkNewVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">    </span><span class="token comment" style="color:#a89984">// Verifica conexión WiFi</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">    </span><span class="token keyword" style="color:#ea6962">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">WiFi</span><span class="token punctuation">.</span><span class="token function" style="color:#d8a657">status</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token operator" style="color:#a89984">!=</span><span class="token plain"> WL_CONNECTED</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">        Serial</span><span class="token punctuation">.</span><span class="token function" style="color:#d8a657">println</span><span class="token punctuation">(</span><span class="token string" style="color:#89b482">&quot;WiFi no conectado&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">        </span><span class="token keyword" style="color:#ea6962">return</span><span class="token plain"> </span><span class="token operator" style="color:#a89984">-</span><span class="token number" style="color:#d3869b">1</span><span class="token punctuation">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">    </span><span class="token comment" style="color:#a89984">// Objetos y primeras configuraciones</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">    WiFiClientSecure client</span><span class="token punctuation">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">    HTTPClient http</span><span class="token punctuation">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">    client</span><span class="token punctuation">.</span><span class="token function" style="color:#d8a657">setCACert</span><span class="token punctuation">(</span><span class="token plain">SERVER_ROOT_CA</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">    http</span><span class="token punctuation">.</span><span class="token function" style="color:#d8a657">setTimeout</span><span class="token punctuation">(</span><span class="token number" style="color:#d3869b">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">    </span><span class="token comment" style="color:#a89984">// Inicia conexión</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">    </span><span class="token keyword" style="color:#ea6962">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token operator" style="color:#a89984">!</span><span class="token plain">http</span><span class="token punctuation">.</span><span class="token function" style="color:#d8a657">begin</span><span class="token punctuation">(</span><span class="token plain">client</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string" style="color:#89b482">&quot;https://apuntes.christianherrera.com.ar/ota/version.txt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">        </span><span class="token keyword" style="color:#ea6962">return</span><span class="token plain"> </span><span class="token operator" style="color:#a89984">-</span><span class="token number" style="color:#d3869b">1</span><span class="token punctuation">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">    </span><span class="token comment" style="color:#a89984">// Realiza la petición</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">    </span><span class="token keyword" style="color:#ea6962">int</span><span class="token plain"> httpCode </span><span class="token operator" style="color:#a89984">=</span><span class="token plain"> http</span><span class="token punctuation">.</span><span class="token function" style="color:#d8a657">GET</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">    </span><span class="token keyword" style="color:#ea6962">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">httpCode </span><span class="token operator" style="color:#a89984">!=</span><span class="token plain"> HTTP_CODE_OK</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">        Serial</span><span class="token punctuation">.</span><span class="token function" style="color:#d8a657">printf</span><span class="token punctuation">(</span><span class="token string" style="color:#89b482">&quot;HTTP error: %d\n&quot;</span><span class="token punctuation">,</span><span class="token plain"> httpCode</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">        http</span><span class="token punctuation">.</span><span class="token function" style="color:#d8a657">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">        </span><span class="token keyword" style="color:#ea6962">return</span><span class="token plain"> </span><span class="token operator" style="color:#a89984">-</span><span class="token number" style="color:#d3869b">1</span><span class="token punctuation">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">    </span><span class="token comment" style="color:#a89984">// Leo el contenido de version.txt (máximo 7 bytes)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">    </span><span class="token keyword" style="color:#ea6962">char</span><span class="token plain"> buf</span><span class="token punctuation">[</span><span class="token number" style="color:#d3869b">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">    </span><span class="token function" style="color:#d8a657">memset</span><span class="token punctuation">(</span><span class="token plain">buf</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token number" style="color:#d3869b">0</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token keyword" style="color:#ea6962">sizeof</span><span class="token punctuation">(</span><span class="token plain">buf</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">    WiFiClient</span><span class="token operator" style="color:#a89984">*</span><span class="token plain"> stream </span><span class="token operator" style="color:#a89984">=</span><span class="token plain"> http</span><span class="token punctuation">.</span><span class="token function" style="color:#d8a657">getStreamPtr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">    size_t len </span><span class="token operator" style="color:#a89984">=</span><span class="token plain"> stream</span><span class="token operator" style="color:#a89984">-&gt;</span><span class="token function" style="color:#d8a657">readBytesUntil</span><span class="token punctuation">(</span><span class="token char" style="color:#a9b665">&#x27;\n&#x27;</span><span class="token punctuation">,</span><span class="token plain"> buf</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token keyword" style="color:#ea6962">sizeof</span><span class="token punctuation">(</span><span class="token plain">buf</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token operator" style="color:#a89984">-</span><span class="token plain"> </span><span class="token number" style="color:#d3869b">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">    http</span><span class="token punctuation">.</span><span class="token function" style="color:#d8a657">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">    </span><span class="token comment" style="color:#a89984">// Convierto a entero y comparo con el actual</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">    </span><span class="token keyword" style="color:#ea6962">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">len </span><span class="token operator" style="color:#a89984">==</span><span class="token plain"> </span><span class="token number" style="color:#d3869b">0</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token keyword" style="color:#ea6962">return</span><span class="token plain"> </span><span class="token operator" style="color:#a89984">-</span><span class="token number" style="color:#d3869b">1</span><span class="token punctuation">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">    </span><span class="token keyword" style="color:#ea6962">return</span><span class="token punctuation">(</span><span class="token function" style="color:#d8a657">atoi</span><span class="token punctuation">(</span><span class="token plain">buf</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain"></span><span class="token punctuation">}</span><br></span></code></pre></div></div>
<p>En este ejemplo se ven algunos detalles importantes:</p>
<ul>
<li class="">Utiliza HTTPS para la conexión segura.</li>
<li class="">Lee el contenido del archivo <code>version.txt</code> hasta un salto de línea.</li>
<li class="">Utiliza un buffer de 8 bytes para almacenar la versión leída.</li>
<li class="">La función retorna la version leida como un entero, o -1 en caso de error.</li>
</ul>
<br>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="descargar-y-aplicar-la-actualización-si-es-necesario">Descargar y aplicar la actualización si es necesario.<a href="#descargar-y-aplicar-la-actualización-si-es-necesario" class="hash-link" aria-label="Enlace directo al Descargar y aplicar la actualización si es necesario." title="Enlace directo al Descargar y aplicar la actualización si es necesario." translate="no">​</a></h3>
<p>La función para descargar y aplicar la actualización OTA es la siguiente:</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#ebdbb2;--prism-background-color:#292828"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#ebdbb2;background-color:#292828"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ebdbb2"><span class="token keyword" style="color:#ea6962">void</span><span class="token plain"> </span><span class="token function" style="color:#d8a657">processUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">    </span><span class="token keyword" style="color:#ea6962">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">WiFi</span><span class="token punctuation">.</span><span class="token function" style="color:#d8a657">status</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token operator" style="color:#a89984">!=</span><span class="token plain"> WL_CONNECTED</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">        Serial</span><span class="token punctuation">.</span><span class="token function" style="color:#d8a657">println</span><span class="token punctuation">(</span><span class="token string" style="color:#89b482">&quot;WiFi no conectado&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">        </span><span class="token keyword" style="color:#ea6962">return</span><span class="token punctuation">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">    </span><span class="token comment" style="color:#a89984">// Objetos y primeras configuraciones</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">    WiFiClientSecure client</span><span class="token punctuation">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">    client</span><span class="token punctuation">.</span><span class="token function" style="color:#d8a657">setCACert</span><span class="token punctuation">(</span><span class="token plain">SERVER_ROOT_CA</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">    httpUpdate</span><span class="token punctuation">.</span><span class="token function" style="color:#d8a657">rebootOnUpdate</span><span class="token punctuation">(</span><span class="token boolean" style="color:#ea6962">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">    </span><span class="token comment" style="color:#a89984">// Inicia actualización OTA</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">    Serial</span><span class="token punctuation">.</span><span class="token function" style="color:#d8a657">println</span><span class="token punctuation">(</span><span class="token string" style="color:#89b482">&quot;Iniciando OTA HTTPS...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">    t_httpUpdate_return ret </span><span class="token operator" style="color:#a89984">=</span><span class="token plain"> httpUpdate</span><span class="token punctuation">.</span><span class="token function" style="color:#d8a657">update</span><span class="token punctuation">(</span><span class="token plain">client</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string" style="color:#89b482">&quot;https://apuntes.christianherrera.com.ar/ota/firmware.bin&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">    </span><span class="token comment" style="color:#a89984">// Manejo de resultados</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">    </span><span class="token keyword" style="color:#ea6962">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">ret </span><span class="token operator" style="color:#a89984">==</span><span class="token plain"> HTTP_UPDATE_FAILED</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">        Serial</span><span class="token punctuation">.</span><span class="token function" style="color:#d8a657">printf</span><span class="token punctuation">(</span><span class="token string" style="color:#89b482">&quot;OTA falló (%d): %s\n&quot;</span><span class="token punctuation">,</span><span class="token plain"> httpUpdate</span><span class="token punctuation">.</span><span class="token function" style="color:#d8a657">getLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"> httpUpdate</span><span class="token punctuation">.</span><span class="token function" style="color:#d8a657">getLastErrorString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function" style="color:#d8a657">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain"></span><span class="token punctuation">}</span><br></span></code></pre></div></div>
<p>En este ejemplo:</p>
<ul>
<li class="">Se utiliza la función <code>httpUpdate.update()</code> para descargar y aplicar la actualización desde el servidor.</li>
<li class="">Se maneja el resultado de la actualización, imprimiendo un mensaje en caso de fallo.</li>
<li class="">Si la actualización es exitosa, el dispositivo se reiniciará automáticamente.</li>
</ul>
<br>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="sketch-completo">Sketch Completo<a href="#sketch-completo" class="hash-link" aria-label="Enlace directo al Sketch Completo" title="Enlace directo al Sketch Completo" translate="no">​</a></h3>
<p>A continuación se muestra un sketch completo que integra ambas funciones y realiza la verificación y actualización OTA.
Para el ejemplo, se utiliza las URL de <code>https://raw.githubusercontent.com/...</code> dado que es la url que devuelve el <em><strong>Content-Length</strong></em> del archivo <code>firmware.bin</code>. La url con dominio personal no devuelve este encabezado, lo que provoca un error en la actualización OTA.</p>
<details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary>Archivo de Configuración</summary><div><div class="collapsibleContent_i85q"><div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#ebdbb2;--prism-background-color:#292828"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-ini codeBlock_bY9V thin-scrollbar" style="color:#ebdbb2;background-color:#292828"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ebdbb2"><span class="token plain">[env:esp32-c3-devkitm-1]</span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">platform = espressif32</span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">board = esp32-c3-devkitm-1</span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">framework = arduino</span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">build_flags = </span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">	-D ARDUINO_USB_MODE=1</span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">	-D ARDUINO_USB_CDC_ON_BOOT=1</span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">	-D CORE_DEBUG_LEVEL=0</span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">	-D FIRMWARE_VERSION=1</span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">monitor_speed = 115200</span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">monitor_filters = send_on_enter, time, esp32_exception_decoder, log2file</span><br></span></code></pre></div></div></div></div></details>
<details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary>Sketch Completo</summary><div><div class="collapsibleContent_i85q"><div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#ebdbb2;--prism-background-color:#292828"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#ebdbb2;background-color:#292828"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ebdbb2"><span class="token macro property directive-hash" style="color:#ea6962">#</span><span class="token macro property directive keyword" style="color:#ea6962">include</span><span class="token macro property" style="color:#ea6962"> </span><span class="token macro property string" style="color:#89b482">&lt;Arduino.h&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#ea6962">#</span><span class="token macro property directive keyword" style="color:#ea6962">include</span><span class="token macro property" style="color:#ea6962"> </span><span class="token macro property string" style="color:#89b482">&lt;HTTPClient.h&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#ea6962">#</span><span class="token macro property directive keyword" style="color:#ea6962">include</span><span class="token macro property" style="color:#ea6962"> </span><span class="token macro property string" style="color:#89b482">&lt;HTTPUpdate.h&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#ea6962">#</span><span class="token macro property directive keyword" style="color:#ea6962">include</span><span class="token macro property" style="color:#ea6962"> </span><span class="token macro property string" style="color:#89b482">&lt;WiFi.h&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#ea6962">#</span><span class="token macro property directive keyword" style="color:#ea6962">include</span><span class="token macro property" style="color:#ea6962"> </span><span class="token macro property string" style="color:#89b482">&lt;WiFiClientSecure.h&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain"></span><span class="token keyword" style="color:#ea6962">const</span><span class="token plain"> </span><span class="token keyword" style="color:#ea6962">char</span><span class="token operator" style="color:#a89984">*</span><span class="token plain"> host_ssid </span><span class="token operator" style="color:#a89984">=</span><span class="token plain"> </span><span class="token string" style="color:#89b482">&quot;WIFI_SSID&quot;</span><span class="token punctuation">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain"></span><span class="token keyword" style="color:#ea6962">const</span><span class="token plain"> </span><span class="token keyword" style="color:#ea6962">char</span><span class="token operator" style="color:#a89984">*</span><span class="token plain"> host_pass </span><span class="token operator" style="color:#a89984">=</span><span class="token plain"> </span><span class="token string" style="color:#89b482">&quot;WIFI_PASS&quot;</span><span class="token punctuation">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain"></span><span class="token keyword" style="color:#ea6962">char</span><span class="token plain"> buffer</span><span class="token punctuation">[</span><span class="token number" style="color:#d3869b">128</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain"></span><span class="token keyword" style="color:#ea6962">const</span><span class="token plain"> </span><span class="token keyword" style="color:#ea6962">char</span><span class="token plain"> SERVER_ROOT_CA</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator" style="color:#a89984">=</span><span class="token plain"> </span><span class="token raw-string string" style="color:#89b482">R&quot;EOF(</span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token raw-string string" style="color:#89b482">-----BEGIN CERTIFICATE-----</span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token raw-string string" style="color:#89b482">MIIF3jCCA8agAwIBAgIQAf1tMPyjylGoG7xkDjUDLTANBgkqhkiG9w0BAQwFADCB</span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token raw-string string" style="color:#89b482">iDELMAkGA1UEBhMCVVMxEzARBgNVBAgTCk5ldyBKZXJzZXkxFDASBgNVBAcTC0pl</span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token raw-string string" style="color:#89b482">cnNleSBDaXR5MR4wHAYDVQQKExVUaGUgVVNFUlRSVVNUIE5ldHdvcmsxLjAsBgNV</span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token raw-string string" style="color:#89b482">BAMTJVVTRVJUcnVzdCBSU0EgQ2VydGlmaWNhdGlvbiBBdXRob3JpdHkwHhcNMTAw</span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token raw-string string" style="color:#89b482">MjAxMDAwMDAwWhcNMzgwMTE4MjM1OTU5WjCBiDELMAkGA1UEBhMCVVMxEzARBgNV</span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token raw-string string" style="color:#89b482">BAgTCk5ldyBKZXJzZXkxFDASBgNVBAcTC0plcnNleSBDaXR5MR4wHAYDVQQKExVU</span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token raw-string string" style="color:#89b482">aGUgVVNFUlRSVVNUIE5ldHdvcmsxLjAsBgNVBAMTJVVTRVJUcnVzdCBSU0EgQ2Vy</span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token raw-string string" style="color:#89b482">dGlmaWNhdGlvbiBBdXRob3JpdHkwggIiMA0GCSqGSIb3DQEBAQUAA4ICDwAwggIK</span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token raw-string string" style="color:#89b482">AoICAQCAEmUXNg7D2wiz0KxXDXbtzSfTTK1Qg2HiqiBNCS1kCdzOiZ/MPans9s/B</span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token raw-string string" style="color:#89b482">3PHTsdZ7NygRK0faOca8Ohm0X6a9fZ2jY0K2dvKpOyuR+OJv0OwWIJAJPuLodMkY</span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token raw-string string" style="color:#89b482">tJHUYmTbf6MG8YgYapAiPLz+E/CHFHv25B+O1ORRxhFnRghRy4YUVD+8M/5+bJz/</span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token raw-string string" style="color:#89b482">Fp0YvVGONaanZshyZ9shZrHUm3gDwFA66Mzw3LyeTP6vBZY1H1dat//O+T23LLb2</span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token raw-string string" style="color:#89b482">VN3I5xI6Ta5MirdcmrS3ID3KfyI0rn47aGYBROcBTkZTmzNg95S+UzeQc0PzMsNT</span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token raw-string string" style="color:#89b482">79uq/nROacdrjGCT3sTHDN/hMq7MkztReJVni+49Vv4M0GkPGw/zJSZrM233bkf6</span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token raw-string string" style="color:#89b482">c0Plfg6lZrEpfDKEY1WJxA3Bk1QwGROs0303p+tdOmw1XNtB1xLaqUkL39iAigmT</span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token raw-string string" style="color:#89b482">Yo61Zs8liM2EuLE/pDkP2QKe6xJMlXzzawWpXhaDzLhn4ugTncxbgtNMs+1b/97l</span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token raw-string string" style="color:#89b482">c6wjOy0AvzVVdAlJ2ElYGn+SNuZRkg7zJn0cTRe8yexDJtC/QV9AqURE9JnnV4ee</span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token raw-string string" style="color:#89b482">UB9XVKg+/XRjL7FQZQnmWEIuQxpMtPAlR1n6BB6T1CZGSlCBst6+eLf8ZxXhyVeE</span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token raw-string string" style="color:#89b482">Hg9j1uliutZfVS7qXMYoCAQlObgOK6nyTJccBz8NUvXt7y+CDwIDAQABo0IwQDAd</span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token raw-string string" style="color:#89b482">BgNVHQ4EFgQUU3m/WqorSs9UgOHYm8Cd8rIDZsswDgYDVR0PAQH/BAQDAgEGMA8G</span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token raw-string string" style="color:#89b482">A1UdEwEB/wQFMAMBAf8wDQYJKoZIhvcNAQEMBQADggIBAFzUfA3P9wF9QZllDHPF</span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token raw-string string" style="color:#89b482">Up/L+M+ZBn8b2kMVn54CVVeWFPFSPCeHlCjtHzoBN6J2/FNQwISbxmtOuowhT6KO</span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token raw-string string" style="color:#89b482">VWKR82kV2LyI48SqC/3vqOlLVSoGIG1VeCkZ7l8wXEskEVX/JJpuXior7gtNn3/3</span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token raw-string string" style="color:#89b482">ATiUFJVDBwn7YKnuHKsSjKCaXqeYalltiz8I+8jRRa8YFWSQEg9zKC7F4iRO/Fjs</span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token raw-string string" style="color:#89b482">8PRF/iKz6y+O0tlFYQXBl2+odnKPi4w2r78NBc5xjeambx9spnFixdjQg3IM8WcR</span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token raw-string string" style="color:#89b482">iQycE0xyNN+81XHfqnHd4blsjDwSXWXavVcStkNr/+XeTWYRUc+ZruwXtuhxkYze</span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token raw-string string" style="color:#89b482">Sf7dNXGiFSeUHM9h4ya7b6NnJSFd5t0dCy5oGzuCr+yDZ4XUmFF0sbmZgIn/f3gZ</span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token raw-string string" style="color:#89b482">XHlKYC6SQK5MNyosycdiyA5d9zZbyuAlJQG03RoHnHcAP9Dc1ew91Pq7P8yF1m9/</span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token raw-string string" style="color:#89b482">qS3fuQL39ZeatTXaw2ewh0qpKJ4jjv9cJ2vhsE/zB+4ALtRZh8tSQZXq9EfX7mRB</span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token raw-string string" style="color:#89b482">VXyNWQKV3WKdwrnuWih0hKWbt5DHDAff9Yk2dDLWKMGwsAvgnEzDHNb842m1R0aB</span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token raw-string string" style="color:#89b482">L6KCq9NjRHDEjf8tM7qtj3u1cIiuPhnPQCjY/MiQu12ZIvVS5ljFH4gxQ+6IHdfG</span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token raw-string string" style="color:#89b482">jjxDah2nGN59PRbxYvnKkKj9</span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token raw-string string" style="color:#89b482">-----END CERTIFICATE-----</span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token raw-string string" style="color:#89b482">)EOF&quot;</span><span class="token punctuation">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain"></span><span class="token keyword" style="color:#ea6962">int</span><span class="token plain"> </span><span class="token function" style="color:#d8a657">checkNewVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">    </span><span class="token comment" style="color:#a89984">// Verifica conexión WiFi</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">    </span><span class="token keyword" style="color:#ea6962">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">WiFi</span><span class="token punctuation">.</span><span class="token function" style="color:#d8a657">status</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token operator" style="color:#a89984">!=</span><span class="token plain"> WL_CONNECTED</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">        Serial</span><span class="token punctuation">.</span><span class="token function" style="color:#d8a657">println</span><span class="token punctuation">(</span><span class="token string" style="color:#89b482">&quot;WiFi no conectado&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">        </span><span class="token keyword" style="color:#ea6962">return</span><span class="token plain"> </span><span class="token operator" style="color:#a89984">-</span><span class="token number" style="color:#d3869b">1</span><span class="token punctuation">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">    </span><span class="token comment" style="color:#a89984">// Objetos y primeras configuraciones</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">    WiFiClientSecure client</span><span class="token punctuation">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">    HTTPClient http</span><span class="token punctuation">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">    client</span><span class="token punctuation">.</span><span class="token function" style="color:#d8a657">setCACert</span><span class="token punctuation">(</span><span class="token plain">SERVER_ROOT_CA</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">    http</span><span class="token punctuation">.</span><span class="token function" style="color:#d8a657">setTimeout</span><span class="token punctuation">(</span><span class="token number" style="color:#d3869b">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">    </span><span class="token comment" style="color:#a89984">// Inicia conexión</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">    </span><span class="token keyword" style="color:#ea6962">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token operator" style="color:#a89984">!</span><span class="token plain">http</span><span class="token punctuation">.</span><span class="token function" style="color:#d8a657">begin</span><span class="token punctuation">(</span><span class="token plain">client</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string" style="color:#89b482">&quot;https://raw.githubusercontent.com/christian-herrera/apuntes/main/static/ota/version.txt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">        </span><span class="token keyword" style="color:#ea6962">return</span><span class="token plain"> </span><span class="token operator" style="color:#a89984">-</span><span class="token number" style="color:#d3869b">1</span><span class="token punctuation">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">    </span><span class="token comment" style="color:#a89984">// Realiza la petición</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">    </span><span class="token keyword" style="color:#ea6962">int</span><span class="token plain"> httpCode </span><span class="token operator" style="color:#a89984">=</span><span class="token plain"> http</span><span class="token punctuation">.</span><span class="token function" style="color:#d8a657">GET</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">    </span><span class="token keyword" style="color:#ea6962">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">httpCode </span><span class="token operator" style="color:#a89984">!=</span><span class="token plain"> HTTP_CODE_OK</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">        Serial</span><span class="token punctuation">.</span><span class="token function" style="color:#d8a657">printf</span><span class="token punctuation">(</span><span class="token string" style="color:#89b482">&quot;HTTP error: %d\n&quot;</span><span class="token punctuation">,</span><span class="token plain"> httpCode</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">        http</span><span class="token punctuation">.</span><span class="token function" style="color:#d8a657">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">        </span><span class="token keyword" style="color:#ea6962">return</span><span class="token plain"> </span><span class="token operator" style="color:#a89984">-</span><span class="token number" style="color:#d3869b">1</span><span class="token punctuation">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">    </span><span class="token comment" style="color:#a89984">// Leo el contenido de version.txt (máximo 7 bytes)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">    </span><span class="token keyword" style="color:#ea6962">char</span><span class="token plain"> buf</span><span class="token punctuation">[</span><span class="token number" style="color:#d3869b">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">    </span><span class="token function" style="color:#d8a657">memset</span><span class="token punctuation">(</span><span class="token plain">buf</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token number" style="color:#d3869b">0</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token keyword" style="color:#ea6962">sizeof</span><span class="token punctuation">(</span><span class="token plain">buf</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">    WiFiClient</span><span class="token operator" style="color:#a89984">*</span><span class="token plain"> stream </span><span class="token operator" style="color:#a89984">=</span><span class="token plain"> http</span><span class="token punctuation">.</span><span class="token function" style="color:#d8a657">getStreamPtr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">    size_t len </span><span class="token operator" style="color:#a89984">=</span><span class="token plain"> stream</span><span class="token operator" style="color:#a89984">-&gt;</span><span class="token function" style="color:#d8a657">readBytesUntil</span><span class="token punctuation">(</span><span class="token char" style="color:#a9b665">&#x27;\n&#x27;</span><span class="token punctuation">,</span><span class="token plain"> buf</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token keyword" style="color:#ea6962">sizeof</span><span class="token punctuation">(</span><span class="token plain">buf</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token operator" style="color:#a89984">-</span><span class="token plain"> </span><span class="token number" style="color:#d3869b">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">    http</span><span class="token punctuation">.</span><span class="token function" style="color:#d8a657">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">    </span><span class="token comment" style="color:#a89984">// Convierto a entero y comparo con el actual</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">    </span><span class="token keyword" style="color:#ea6962">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">len </span><span class="token operator" style="color:#a89984">==</span><span class="token plain"> </span><span class="token number" style="color:#d3869b">0</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token keyword" style="color:#ea6962">return</span><span class="token plain"> </span><span class="token operator" style="color:#a89984">-</span><span class="token number" style="color:#d3869b">1</span><span class="token punctuation">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">    </span><span class="token keyword" style="color:#ea6962">return</span><span class="token punctuation">(</span><span class="token function" style="color:#d8a657">atoi</span><span class="token punctuation">(</span><span class="token plain">buf</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain"></span><span class="token keyword" style="color:#ea6962">void</span><span class="token plain"> </span><span class="token function" style="color:#d8a657">processUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">    </span><span class="token keyword" style="color:#ea6962">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">WiFi</span><span class="token punctuation">.</span><span class="token function" style="color:#d8a657">status</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token operator" style="color:#a89984">!=</span><span class="token plain"> WL_CONNECTED</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">        Serial</span><span class="token punctuation">.</span><span class="token function" style="color:#d8a657">println</span><span class="token punctuation">(</span><span class="token string" style="color:#89b482">&quot;WiFi no conectado&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">        </span><span class="token keyword" style="color:#ea6962">return</span><span class="token punctuation">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">    </span><span class="token comment" style="color:#a89984">// Objetos y primeras configuraciones</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">    WiFiClientSecure client</span><span class="token punctuation">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">    client</span><span class="token punctuation">.</span><span class="token function" style="color:#d8a657">setCACert</span><span class="token punctuation">(</span><span class="token plain">SERVER_ROOT_CA</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">    httpUpdate</span><span class="token punctuation">.</span><span class="token function" style="color:#d8a657">rebootOnUpdate</span><span class="token punctuation">(</span><span class="token boolean" style="color:#ea6962">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">    httpUpdate</span><span class="token punctuation">.</span><span class="token function" style="color:#d8a657">setFollowRedirects</span><span class="token punctuation">(</span><span class="token plain">HTTPC_STRICT_FOLLOW_REDIRECTS</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">    </span><span class="token comment" style="color:#a89984">// Inicia actualización OTA</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">    Serial</span><span class="token punctuation">.</span><span class="token function" style="color:#d8a657">println</span><span class="token punctuation">(</span><span class="token string" style="color:#89b482">&quot;Iniciando OTA HTTPS...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">    t_httpUpdate_return ret </span><span class="token operator" style="color:#a89984">=</span><span class="token plain"> httpUpdate</span><span class="token punctuation">.</span><span class="token function" style="color:#d8a657">update</span><span class="token punctuation">(</span><span class="token plain">client</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string" style="color:#89b482">&quot;https://raw.githubusercontent.com/christian-herrera/apuntes/main/static/ota/firmware.bin&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">    </span><span class="token comment" style="color:#a89984">// Manejo de resultados</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">    </span><span class="token keyword" style="color:#ea6962">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">ret </span><span class="token operator" style="color:#a89984">==</span><span class="token plain"> HTTP_UPDATE_FAILED</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">        Serial</span><span class="token punctuation">.</span><span class="token function" style="color:#d8a657">printf</span><span class="token punctuation">(</span><span class="token string" style="color:#89b482">&quot;OTA falló (%d): %s\n&quot;</span><span class="token punctuation">,</span><span class="token plain"> httpUpdate</span><span class="token punctuation">.</span><span class="token function" style="color:#d8a657">getLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"> httpUpdate</span><span class="token punctuation">.</span><span class="token function" style="color:#d8a657">getLastErrorString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function" style="color:#d8a657">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain"></span><span class="token keyword" style="color:#ea6962">void</span><span class="token plain"> </span><span class="token function" style="color:#d8a657">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">    </span><span class="token function" style="color:#d8a657">analogWrite</span><span class="token punctuation">(</span><span class="token number" style="color:#d3869b">8</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token number" style="color:#d3869b">255</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">    Serial</span><span class="token punctuation">.</span><span class="token function" style="color:#d8a657">begin</span><span class="token punctuation">(</span><span class="token number" style="color:#d3869b">115200</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">    </span><span class="token function" style="color:#d8a657">delay</span><span class="token punctuation">(</span><span class="token number" style="color:#d3869b">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">    </span><span class="token comment" style="color:#a89984">// Modo STA</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">    WiFi</span><span class="token punctuation">.</span><span class="token function" style="color:#d8a657">mode</span><span class="token punctuation">(</span><span class="token plain">WIFI_STA</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">    WiFi</span><span class="token punctuation">.</span><span class="token function" style="color:#d8a657">begin</span><span class="token punctuation">(</span><span class="token plain">host_ssid</span><span class="token punctuation">,</span><span class="token plain"> host_pass</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">    </span><span class="token comment" style="color:#a89984">// Espera hasta conectarse</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">    </span><span class="token keyword" style="color:#ea6962">while</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">WiFi</span><span class="token punctuation">.</span><span class="token function" style="color:#d8a657">status</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token operator" style="color:#a89984">!=</span><span class="token plain"> WL_CONNECTED</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">        </span><span class="token function" style="color:#d8a657">delay</span><span class="token punctuation">(</span><span class="token number" style="color:#d3869b">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">    Serial</span><span class="token punctuation">.</span><span class="token function" style="color:#d8a657">println</span><span class="token punctuation">(</span><span class="token string" style="color:#89b482">&quot;\nConectado!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">    </span><span class="token comment" style="color:#a89984">// Verificacion</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">    </span><span class="token function" style="color:#d8a657">analogWrite</span><span class="token punctuation">(</span><span class="token number" style="color:#d3869b">8</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token number" style="color:#d3869b">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">    Serial</span><span class="token punctuation">.</span><span class="token function" style="color:#d8a657">printf</span><span class="token punctuation">(</span><span class="token string" style="color:#89b482">&quot;Version actual: %d\n&quot;</span><span class="token punctuation">,</span><span class="token plain"> FIRMWARE_VERSION</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">    </span><span class="token keyword" style="color:#ea6962">int</span><span class="token plain"> newVersion </span><span class="token operator" style="color:#a89984">=</span><span class="token plain"> </span><span class="token function" style="color:#d8a657">checkNewVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">    </span><span class="token keyword" style="color:#ea6962">if</span><span class="token punctuation">(</span><span class="token plain">newVersion </span><span class="token operator" style="color:#a89984">&gt;</span><span class="token plain"> FIRMWARE_VERSION</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">        Serial</span><span class="token punctuation">.</span><span class="token function" style="color:#d8a657">printf</span><span class="token punctuation">(</span><span class="token string" style="color:#89b482">&quot;Nueva version disponible: %d (actual: %d)\n&quot;</span><span class="token punctuation">,</span><span class="token plain"> newVersion</span><span class="token punctuation">,</span><span class="token plain"> FIRMWARE_VERSION</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">        </span><span class="token function" style="color:#d8a657">delay</span><span class="token punctuation">(</span><span class="token number" style="color:#d3869b">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">        </span><span class="token function" style="color:#d8a657">processUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword" style="color:#ea6962">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">        Serial</span><span class="token punctuation">.</span><span class="token function" style="color:#d8a657">println</span><span class="token punctuation">(</span><span class="token string" style="color:#89b482">&quot;No hay nueva version disponible.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">    </span><span class="token function" style="color:#d8a657">analogWrite</span><span class="token punctuation">(</span><span class="token number" style="color:#d3869b">8</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token number" style="color:#d3869b">255</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">    </span><span class="token function" style="color:#d8a657">delay</span><span class="token punctuation">(</span><span class="token number" style="color:#d3869b">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain"></span><span class="token keyword" style="color:#ea6962">void</span><span class="token plain"> </span><span class="token function" style="color:#d8a657">loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">    </span><span class="token keyword" style="color:#ea6962">static</span><span class="token plain"> </span><span class="token keyword" style="color:#ea6962">unsigned</span><span class="token plain"> </span><span class="token keyword" style="color:#ea6962">long</span><span class="token plain"> mark </span><span class="token operator" style="color:#a89984">=</span><span class="token plain"> </span><span class="token number" style="color:#d3869b">0</span><span class="token punctuation">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">    </span><span class="token keyword" style="color:#ea6962">static</span><span class="token plain"> </span><span class="token keyword" style="color:#ea6962">int</span><span class="token plain"> level </span><span class="token operator" style="color:#a89984">=</span><span class="token plain"> </span><span class="token number" style="color:#d3869b">0</span><span class="token punctuation">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">    </span><span class="token keyword" style="color:#ea6962">static</span><span class="token plain"> </span><span class="token keyword" style="color:#ea6962">bool</span><span class="token plain"> direction </span><span class="token operator" style="color:#a89984">=</span><span class="token plain"> </span><span class="token boolean" style="color:#ea6962">false</span><span class="token punctuation">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">    </span><span class="token keyword" style="color:#ea6962">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token function" style="color:#d8a657">millis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token operator" style="color:#a89984">-</span><span class="token plain"> mark </span><span class="token operator" style="color:#a89984">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#d3869b">10</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">        mark </span><span class="token operator" style="color:#a89984">=</span><span class="token plain"> </span><span class="token function" style="color:#d8a657">millis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">        </span><span class="token function" style="color:#d8a657">analogWrite</span><span class="token punctuation">(</span><span class="token number" style="color:#d3869b">8</span><span class="token punctuation">,</span><span class="token plain"> level</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">        level </span><span class="token operator" style="color:#a89984">=</span><span class="token plain"> level </span><span class="token operator" style="color:#a89984">+</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">direction </span><span class="token operator" style="color:#a89984">?</span><span class="token plain"> </span><span class="token number" style="color:#d3869b">1</span><span class="token plain"> </span><span class="token operator" style="color:#a89984">:</span><span class="token plain"> </span><span class="token operator" style="color:#a89984">-</span><span class="token number" style="color:#d3869b">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">        direction </span><span class="token operator" style="color:#a89984">=</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">level </span><span class="token operator" style="color:#a89984">&gt;=</span><span class="token plain"> </span><span class="token number" style="color:#d3869b">255</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token operator" style="color:#a89984">?</span><span class="token plain"> </span><span class="token boolean" style="color:#ea6962">false</span><span class="token plain"> </span><span class="token operator" style="color:#a89984">:</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">level </span><span class="token operator" style="color:#a89984">&lt;=</span><span class="token plain"> </span><span class="token number" style="color:#d3869b">0</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token operator" style="color:#a89984">?</span><span class="token plain"> </span><span class="token boolean" style="color:#ea6962">true</span><span class="token plain"> </span><span class="token operator" style="color:#a89984">:</span><span class="token plain"> direction</span><span class="token punctuation">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ebdbb2"><span class="token plain"></span><span class="token punctuation">}</span><br></span></code></pre></div></div></div></div></details></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col noPrint_WFHX"></div><div class="col lastUpdated_JAkA"><span class="theme-last-updated">Última actualización<!-- --> en <b><time datetime="2026-02-01T20:48:38.000Z" itemprop="dateModified">1 feb 2026</time></b></span></div></div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Página del documento"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/esp32/webserver"><div class="pagination-nav__sublabel">Anterior</div><div class="pagination-nav__label">Libreria WebServer.h</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#introducción" class="table-of-contents__link toc-highlight">Introducción</a></li><li><a href="#servidor" class="table-of-contents__link toc-highlight">Servidor</a></li><li><a href="#sketch-básico" class="table-of-contents__link toc-highlight">Sketch Básico</a><ul><li><a href="#verificar-la-versión-del-firmware-en-el-servidor" class="table-of-contents__link toc-highlight">Verificar la versión del firmware en el servidor.</a></li><li><a href="#descargar-y-aplicar-la-actualización-si-es-necesario" class="table-of-contents__link toc-highlight">Descargar y aplicar la actualización si es necesario.</a></li><li><a href="#sketch-completo" class="table-of-contents__link toc-highlight">Sketch Completo</a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Apuntes Importantes</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/intro">Bunker de Notas</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Social</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/christian-herrera" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://x.com/chriissrp" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://instagram.com/chris1496.rp" target="_blank" rel="noopener noreferrer" class="footer__link-item">Instagram<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://ar.linkedin.com/in/christian-herrera-ing" target="_blank" rel="noopener noreferrer" class="footer__link-item">Linkedin<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://docusaurus.io/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Docusaurus<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2026 Apuntes, Christian Herrera</div></div></div></footer></div>
</body>
</html>